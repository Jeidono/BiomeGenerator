<html>
  <head>
    <title>Tree Generation</title>
  </head>

  <style>
  body {margin: 0;}
  canvas {width: 100%; height: 100%;}
  </style>

  <body>
	<link rel="shortcut icon" href="#">

   
    <style>
    			body {
    				font-family: Monospace;
    				background-color: lightblue;
    				color: #fff;
    				margin: 0px;
    				overflow: hidden;
    			}
    			#info {
    				position: absolute;
    				top: 10px;
    				width: 100%;
    				text-align: center;
    			}
    </style>

		<script type="importmap">
			{
				"imports": {
					"three": "./build/three.module.js"
				}
			}
		</script>
		
	<script type="module">

    import * as THREE from 'three';
    import { OrbitControls } from './build/controls/OrbitControls.js';
    import { FirstPersonControls } from './build/controls/FirstPersonControls.js';
    import { OBJLoader } from './build/controls/OBJLoader.js';
    import { GUI } from './build/controls/lil-gui.module.min.js';

    //creating scene
    var scene = new THREE.Scene( );
    var ratio = window.innerWidth/window.innerHeight;

    //camera
    var camera = new THREE.PerspectiveCamera(45,ratio,0.1,1000);
    camera.position.set(0,0,15);
	  camera.lookAt(0,0,1);

    // renderer
    var renderer = new THREE.WebGLRenderer( );
    renderer.setSize(window.innerWidth,window.innerHeight);
    document.body.appendChild(renderer.domElement );
  
		//controls for camera
		/*var controls = new FirstPersonControls(camera, renderer.domElement);

		var MyUpdateLoop = function(){
			controls.update(1);
			renderer.render(scene,camera);
			requestAnimationFrame(MyUpdateLoop);
		};*/

    //controls for camera
  var controls = new OrbitControls( camera, renderer.domElement );
  var MyUpdateLoop = function ( )
  {
    renderer.render(scene,camera);
    controls.update();
    requestAnimationFrame(MyUpdateLoop);

  };


  requestAnimationFrame(MyUpdateLoop);

  

  var MyResize = function ( )
  {
    var width = window.innerWidth;
    var height = window.innerHeight;
    renderer.setSize(width,height);
    camera.aspect = width/height;
    camera.updateProjectionMatrix();
    renderer.render(scene,camera);
  };

  window.addEventListener('resize', MyResize);

  var trees = [];
  var n = 300;

  // Create a grass plane
const grassTexture = new THREE.TextureLoader().load('../../Assets/grass.jpg');
const grassGeometry = new THREE.PlaneGeometry(10, 10);
const grassMaterial = new THREE.MeshBasicMaterial({ map: grassTexture, side: THREE.DoubleSide });
const grassplaneNum = 10;
const numRows = 12;
const numCols = 12;
const planeSize = 10;

for (let row = 0; row < numRows; row++) {
    for (let col = 0; col < numCols; col++) {
        const xPos = col * (planeSize) - (numCols * (planeSize)) / 2;
        const zPos = row * (planeSize) - (numRows * (planeSize)) / 2;

        const grassPlane = new THREE.Mesh(grassGeometry, grassMaterial);
        grassPlane.position.set(xPos, -2.01, zPos);
        grassPlane.rotation.x = -Math.PI / 2;
        scene.add(grassPlane);
    }
}

//loading in different tree types
const objLoader = new OBJLoader();

  //generate position for trees
  function generatePosition(trees, size, gap, yPosition){
    var maxAttempts = 100000;
    var attempts = 0;
    
    while (attempts < maxAttempts){
      var position = new THREE.Vector3(
        (Math.random() - 0.5) * size,
        yPosition,
        (Math.random() - 0.5) * size
      );

      var collides = trees.some(trees => position.distanceTo(trees.position) <= 
      trees.geometry.parameters.width + gap);
      if(!collides) {
        return position;
      }
      attempts++;
    }
    return new THREE.Vector3(0, yPosition, 0);
  }

    //creating multiple different trees
    function addTrees()
    {
      for(i = 0; i < trees.length; i++){
        scene.remove(trees[i]);
      }
      trees = [];
      for(var i = 0; i < n; i++){
        var treeModel;
        var rand = Math.random();

        if (rand < 0.2) {
          treeModel = '../../Assets/Trees/bareTreeWithHole.obj';
        } else if (rand < 0.6) {
          treeModel = '../../Assets/Trees/chunkyTree.obj';
        } else if(rand < 0.15){
          treeModel = '../../Assets/Trees/shortNoLeaves.obj';
        }else if(rand < 0.6){
          treeModel = '../../Assets/Trees/skinnyShortTree.obj';
        }else if(rand < 0.6){
          treeModel = '../../Assets/Trees/skinnyTallTree.obj';
        }else if(rand < 0.9){
          treeModel = '../../Assets/Trees/tallTree.obj';
        }else{
          treeModel = '../../Assets/Trees/tallNoLeaves.obj';
        }

        objLoader.load(treeModel, (root) => {
          var material = new THREE.MeshBasicMaterial({color: Math.random() * 0xffffff});
          material.wireframe = true;

          //adjust gap
          var bbox = new THREE.Box3().setFromObject(root);
          var width = bbox.max.x - bbox.min.x;
          root.userData.width = width;

          root.traverse((child) => {
            if(child instanceof THREE.Mesh) {
              child.material = material;
            }
          });

          root.position.copy(generatePosition(trees, 100, 100, -2));  //trees, size, gap, yPosition

          //Adjust y-position
          var height = bbox.max.y - bbox.min.y;
          root.position.y += height / 2;

          scene.add(root);
        });
      }
    }
    addTrees();

     // Add the sky 
    var skyGeometry = new THREE.SphereGeometry(500, 32, 32);
    var skyMaterial = new THREE.MeshBasicMaterial({ color: 0x87ceeb, side: THREE.BackSide });
    var sky = new THREE.Mesh(skyGeometry, skyMaterial);
    scene.add(sky);

    // adding the clouds
    const cloudModel = '../../Assets/cloud.obj';
    objLoader.load (cloudModel, (root) => {
      const cloudMaterial = new THREE.MeshBasicMaterial({color: 0xffffff});
      root.traverse((child)=> {
        if (child instanceof THREE.Mesh){
          child.material = cloudMaterial;
        }
      })
      root.scale.set(50, 50, 100);
      root.position.set(0, 20, 0);
      scene.add(root);
    });
    const birdModel = '../../Assets/Animal/bird.obj';
    objLoader.load(birdModel, (root) => {
    root.scale.set(0.1, 0.1, 0.1);
    root.position.set(-50, -2, 15); 
    root.rotation.y = Math.PI / 2;

    scene.add(root);
});


    </script>
  </body>
</html>
